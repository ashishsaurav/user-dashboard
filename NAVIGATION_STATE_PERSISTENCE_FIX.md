# Navigation State Persistence - Bug Fixes

**Date:** 2025-10-22  
**Issues:** State not persisting correctly, groups re-expanding

---

## üêõ Issues Fixed

### Issue 1: Collapse All Not Working
**Problem:** When clicking "Collapse All", view groups would immediately expand again.

**Root Cause:** The `useEffect` that loads the initial state had viewGroups in dependency array, causing it to re-run and reset the state.

**Solution:**
```typescript
// BEFORE (BAD):
useEffect(() => {
  if (viewGroups.length > 0) {
    // This runs every time viewGroups changes!
    setExpandedViewGroups(initialExpanded);
  }
}, [viewGroups, userNavSettings.expandedViewGroups]);

// AFTER (GOOD):
const hasInitializedRef = useRef(false);

useEffect(() => {
  if (viewGroups.length > 0 && !hasInitializedRef.current) {
    // Only runs ONCE on initial load
    setExpandedViewGroups(initialExpanded);
    hasInitializedRef.current = true;
  }
}, [viewGroups, userNavSettings]);
```

---

### Issue 2: Saved State Ignored on Load
**Problem:** Even though backend had saved state, it was being overridden by default (all expanded).

**Root Cause:** The code was treating `undefined` and empty array the same way.

**Critical Fix:**
```typescript
// BEFORE (WRONG):
if (userNavSettings.expandedViewGroups && userNavSettings.expandedViewGroups.length > 0) {
  // Use saved state
} else {
  // Default to all expanded
}

// This is WRONG because empty array [] means "all collapsed" (user clicked collapse all)
// But the code treats it as "no saved state" and defaults to all expanded!

// AFTER (CORRECT):
if (userNavSettings.expandedViewGroups !== undefined && userNavSettings.expandedViewGroups !== null) {
  // Use saved state (even if empty array)
  viewGroups.forEach((vg) => {
    initialExpanded[vg.id] = userNavSettings.expandedViewGroups!.includes(vg.id);
  });
} else {
  // Only default to all expanded if NO saved state exists
  viewGroups.forEach((vg) => {
    initialExpanded[vg.id] = true;
  });
}
```

**Key Insight:**
- `expandedViewGroups = []` ‚Üí All collapsed (valid state)
- `expandedViewGroups = undefined` ‚Üí No saved state (use default)

---

### Issue 3: Navigation Panel Collapse State Not Loading
**Problem:** Even when `isNavigationCollapsed = true` in backend, panel would load as expanded.

**Root Cause:** State was initialized as `false` before API data loaded.

**Solution:**
```typescript
// BEFORE:
const [isDockCollapsed, setIsDockCollapsed] = useState(false);

// AFTER:
const [isDockCollapsed, setIsDockCollapsed] = useState(() => {
  // Initialize from API data if available
  return apiNavSettings?.isNavigationCollapsed ?? false;
});

// PLUS: Update when API data loads
useEffect(() => {
  if (apiNavSettings?.isNavigationCollapsed !== undefined) {
    setIsDockCollapsed(apiNavSettings.isNavigationCollapsed);
  }
}, [apiNavSettings]);
```

---

### Issue 4: Button Not Always Visible
**Problem:** Button only showed when `viewGroups.length > 0`.

**Solution:**
```typescript
// BEFORE:
{!isHorizontalLayout && viewGroups.length > 0 && (
  <div className="nav-toolbar">...</div>
)}

// AFTER:
{!isHorizontalLayout && (
  <div className="nav-toolbar">
    <button disabled={viewGroups.length === 0}>...</button>
  </div>
)}
```

Now the button always shows but is disabled when no groups exist.

---

## üîç State Loading Flow

### Correct Sequence:

```
1. App starts
   ‚Üì
2. useApiData hook fetches data
   ‚Üì
3. apiNavSettings loaded from backend
   {
     expandedViewGroups: ["vg-1", "vg-3"],  // Only these are expanded
     isNavigationCollapsed: true
   }
   ‚Üì
4. DashboardDock receives apiNavSettings
   ‚Üì
5. Sets isDockCollapsed = true (from backend)
   ‚Üì
6. NavigationPanel receives userNavSettings
   ‚Üì
7. Initializes expandedViewGroups (ONLY ONCE)
   {
     "vg-1": true,   // Expanded
     "vg-2": false,  // Collapsed
     "vg-3": true,   // Expanded
     "vg-4": false   // Collapsed
   }
   ‚Üì
8. State is now correctly loaded from backend ‚úÖ
```

---

## üß™ Testing Scenarios

### Scenario 1: Collapse All, Refresh Page

**Steps:**
1. Click "Collapse All"
2. Wait 1 second
3. Refresh page (F5)

**Expected:**
- ‚úÖ All view groups remain collapsed
- ‚úÖ Button shows "Expand All"
- ‚úÖ Backend has `expandedViewGroups: []`

**Debug Output:**
```
üíæ Saving view group expand/collapse state: []
  Total groups: 4
  Expanded count: 0
‚úÖ Saved to backend successfully

[Page refresh]

üîÑ Initializing view group expand state
  Saved expandedViewGroups: []
  ViewGroups count: 4
  ‚úÖ Using saved state from backend
    View Group 1: COLLAPSED
    View Group 2: COLLAPSED
    View Group 3: COLLAPSED
    View Group 4: COLLAPSED
  ‚úÖ Final expanded state: {...all false...}
```

---

### Scenario 2: Expand Some, Collapse Others, Refresh

**Steps:**
1. Expand Group 1
2. Collapse Group 2
3. Expand Group 3
4. Collapse Group 4
5. Refresh page

**Expected:**
- ‚úÖ Group 1 is expanded
- ‚úÖ Group 2 is collapsed
- ‚úÖ Group 3 is expanded
- ‚úÖ Group 4 is collapsed
- ‚úÖ Backend has `expandedViewGroups: ["vg-1", "vg-3"]`

---

### Scenario 3: Collapse Navigation Panel, Refresh

**Steps:**
1. Click hamburger menu to collapse panel
2. Refresh page

**Expected:**
- ‚úÖ Navigation panel loads in collapsed state
- ‚úÖ Shows abbreviated view group names
- ‚úÖ Backend has `isNavigationCollapsed: true`

**Debug Output:**
```
üíæ Saved navigation collapse state: true

[Page refresh]

üìä API NavSettings updated: {...}
üíæ Backend navigation collapse state: true
‚úÖ Applying saved collapse state: true
```

---

## üìä Files Modified

### Frontend Files:
1. ‚úÖ `src/types/index.ts`
   - Added `expandedViewGroups?: string[]`
   - Added `isNavigationCollapsed?: boolean`

2. ‚úÖ `src/services/navigationService.ts`
   - Added field handling in DTOs
   - Added transform methods

3. ‚úÖ `src/components/navigation/NavigationPanel.tsx`
   - Fixed initialization logic (use ref instead of state)
   - Fixed empty array handling
   - Added collapse/expand all buttons
   - Added save state logic
   - Added debug logging

4. ‚úÖ `src/components/navigation/styles/NavigationPanel.css`
   - Created new CSS file
   - Added toolbar styles
   - Added button hover/active states
   - Added disabled state

5. ‚úÖ `src/components/dashboard/DashboardDock.tsx`
   - Initialize with saved state
   - Update when API data loads
   - Save on toggle

---

## üîß Backend Requirements

### Model Update

**File:** `DashboardPortal/Models/NavigationSetting.cs`

```csharp
public class NavigationSetting
{
    public int Id { get; set; }
    public string UserId { get; set; }
    public string ViewGroupOrder { get; set; }      // JSON
    public string ViewOrders { get; set; }          // JSON
    public string HiddenViewGroups { get; set; }    // JSON
    public string HiddenViews { get; set; }         // JSON
    
    // ‚úÖ ADD THESE TWO FIELDS:
    public string ExpandedViewGroups { get; set; }  // JSON array
    public bool? IsNavigationCollapsed { get; set; } // boolean
    
    public DateTime CreatedAt { get; set; }
    public DateTime UpdatedAt { get; set; }
    
    public User User { get; set; }
}
```

### Migration

```bash
cd DashboardPortal
dotnet ef migrations add AddExpandCollapseToNavigationSettings
dotnet ef database update
```

**Generated SQL:**
```sql
ALTER TABLE [NavigationSettings]
ADD [ExpandedViewGroups] nvarchar(max) NULL,
    [IsNavigationCollapsed] bit NULL;
```

### Controller Update

**File:** `DashboardPortal/Controllers/NavigationController.cs`

```csharp
[HttpPut("{userId}")]
public async Task<ActionResult<NavigationSettingDto>> UpdateNavigationSetting(
    string userId,
    [FromBody] UpdateNavigationSettingDto dto)
{
    var setting = await _context.NavigationSettings
        .FirstOrDefaultAsync(ns => ns.UserId == userId);

    if (setting == null)
    {
        setting = new NavigationSetting
        {
            UserId = userId,
            CreatedAt = DateTime.UtcNow
        };
        _context.NavigationSettings.Add(setting);
    }

    setting.ViewGroupOrder = JsonSerializer.Serialize(dto.ViewGroupOrder ?? new List<string>());
    setting.ViewOrders = JsonSerializer.Serialize(dto.ViewOrders ?? new Dictionary<string, List<string>>());
    setting.HiddenViewGroups = JsonSerializer.Serialize(dto.HiddenViewGroups ?? new List<string>());
    setting.HiddenViews = JsonSerializer.Serialize(dto.HiddenViews ?? new List<string>());
    
    // ‚úÖ ADD THESE TWO LINES:
    setting.ExpandedViewGroups = JsonSerializer.Serialize(dto.ExpandedViewGroups ?? new List<string>());
    setting.IsNavigationCollapsed = dto.IsNavigationCollapsed ?? false;
    
    setting.UpdatedAt = DateTime.UtcNow;

    await _context.SaveChangesAsync();

    return Ok(MapToDto(setting));
}

private NavigationSettingDto MapToDto(NavigationSetting setting)
{
    return new NavigationSettingDto
    {
        Id = setting.Id,
        UserId = setting.UserId,
        ViewGroupOrder = JsonSerializer.Deserialize<List<string>>(setting.ViewGroupOrder ?? "[]"),
        ViewOrders = JsonSerializer.Deserialize<Dictionary<string, List<string>>>(setting.ViewOrders ?? "{}"),
        HiddenViewGroups = JsonSerializer.Deserialize<List<string>>(setting.HiddenViewGroups ?? "[]"),
        HiddenViews = JsonSerializer.Deserialize<List<string>>(setting.HiddenViews ?? "[]"),
        
        // ‚úÖ ADD THESE TWO LINES:
        ExpandedViewGroups = JsonSerializer.Deserialize<List<string>>(setting.ExpandedViewGroups ?? "[]"),
        IsNavigationCollapsed = setting.IsNavigationCollapsed ?? false
    };
}
```

---

## üéØ Key Fixes Summary

| Issue | Root Cause | Solution |
|-------|------------|----------|
| Groups re-expand | useEffect dependency array | Use useRef instead of useState for initialization flag |
| Empty array ignored | Treating `[]` as "no state" | Check for `undefined` not length > 0 |
| Button not visible | Conditional on viewGroups length | Always show, disable when empty |
| Panel state ignored | Initialize before API loads | Initialize with API value, update on change |

---

## ‚úÖ Verification Checklist

After deploying backend changes:

- [ ] Click "Collapse All" ‚Üí All groups collapse
- [ ] Refresh page ‚Üí Groups stay collapsed
- [ ] Click "Expand All" ‚Üí All groups expand
- [ ] Refresh page ‚Üí Groups stay expanded
- [ ] Collapse navigation panel ‚Üí Panel collapses
- [ ] Refresh page ‚Üí Panel stays collapsed
- [ ] Expand navigation panel ‚Üí Panel expands
- [ ] Refresh page ‚Üí Panel stays expanded
- [ ] Check browser console for debug logs
- [ ] Verify API calls in Network tab
- [ ] Check database for saved values

---

## üîç Debug Logging

**What to look for in browser console:**

### On Initial Load:
```
üîÑ Initializing view group expand state
  Saved expandedViewGroups: ["vg-1", "vg-3"]
  ViewGroups count: 4
  ‚úÖ Using saved state from backend
    View Group 1: EXPANDED
    View Group 2: COLLAPSED
    View Group 3: EXPANDED
    View Group 4: COLLAPSED
  ‚úÖ Final expanded state: {...}
```

### On Collapse All:
```
üíæ Saving view group expand/collapse state: []
  Total groups: 4
  Expanded count: 0
‚úÖ Saved to backend successfully
```

### On Expand All:
```
üíæ Saving view group expand/collapse state: ["vg-1", "vg-2", "vg-3", "vg-4"]
  Total groups: 4
  Expanded count: 4
‚úÖ Saved to backend successfully
```

### On Navigation Panel Toggle:
```
üíæ Saved navigation collapse state: true
```

---

## üöÄ Next Steps

1. **Apply backend migration:**
   ```bash
   cd DashboardPortal
   dotnet ef migrations add AddExpandCollapseToNavigationSettings
   dotnet ef database update
   ```

2. **Update backend code:**
   - NavigationSetting model
   - NavigationController
   - DTOs

3. **Test:**
   - Test all scenarios in checklist
   - Check console logs
   - Verify database values

4. **Deploy:**
   - Frontend changes are already live
   - Deploy backend changes
   - Clear browser cache if needed

---

**Status:** ‚úÖ Frontend fixes complete, backend migration required

**Expected Behavior After Backend Update:**
- Click "Collapse All" ‚Üí Stays collapsed on refresh ‚úÖ
- Click "Expand All" ‚Üí Stays expanded on refresh ‚úÖ
- Individual group states ‚Üí Persist correctly ‚úÖ
- Navigation panel collapse ‚Üí Persists correctly ‚úÖ
